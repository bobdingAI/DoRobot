# Piper从臂安全改进文档

**最后更新：** 2025-12-25
**维护者：** DoRobot Team
**组件版本：** arm_normal_piper_v2

---

## 目录
- [问题背景](#问题背景)
- [解决方案概述](#解决方案概述)
- [详细改进内容](#详细改进内容)
- [参数配置](#参数配置)
- [使用说明](#使用说明)
- [故障排查](#故障排查)
- [维护记录](#维护记录)

---

## 问题背景

### 原始问题
运行 `/scripts/run_so101.sh` 启动遥操作系统时，松灵Piper从臂会从初始状态开始运动，如果目标位置与当前位置差异过大，机械臂会尝试快速移动到目标位置，导致：

1. **电流瞬间过大**
2. **保险丝熔断**
3. **系统无法正常工作**

### 根本原因分析

1. **主臂立即发送位置**
   - SO101主臂启动后，以30Hz频率（每33ms）读取当前关节角度并发送给从臂
   - 主臂的初始位置可能与从臂当前位置相差很大

2. **从臂无初始位置控制**
   - Piper从臂启动后直接接收主臂位置命令
   - 没有安全的初始位置设置
   - 没有位置差异检查机制

3. **缺少运行时监控**
   - 没有实时监控主从臂位置差异
   - 无法及时发现异常情况
   - 缺少紧急停止机制

---

## 解决方案概述

实现了**三层安全保护机制**：

```
启动保护 → 运行监控 → 紧急停止
   ↓           ↓           ↓
 20度阈值   20度警告    30度停止
```

### 核心改进
1. ✅ 设置安全起始位置
2. ✅ 启动时位置对齐检查
3. ✅ 实时位置差异监控
4. ✅ 分级警告和紧急停止
5. ✅ 详细的错误提示

---

## 详细改进内容

### 1. 安全起始位置设置

**文件：** `main.py` 第56-70行

**改进内容：**
```python
# 从臂启动时移动到实际测量的安全位置
safe_home_position = [5982, -1128, 3940, -19218, 18869, 40103]
```

**获取方法：**
```bash
# 使用测试脚本读取当前位置
python /home/demo/Public/DoRobot/scripts/test_piper_move.py --read-only --can-bus can_left
```

**作用：**
- 确保从臂从已知的安全位置开始
- 避免从未知位置启动导致的大幅度运动
- 等待3秒确保到达目标位置

---

### 2. 启动时位置对齐检查

**文件：** `main.py` 第151-162行

**检查逻辑：**
```python
if not first_command_received:
    if max_diff > POSITION_DIFF_WARNING:  # 20度
        # 拒绝启动，提示用户对齐主从臂
        continue
```

**触发条件：**
- 首次接收主臂命令时
- 任何关节位置差异 > 20度

**用户操作：**
1. 系统显示当前从臂位置和主臂目标位置
2. 用户手动移动主臂到接近从臂位置
3. 位置差异 < 20度时自动开始遥操作

---

### 3. 实时位置差异监控

**文件：** `main.py` 第108-131行

**监控内容：**
- 每次接收命令时读取从臂当前位置
- 计算6个关节的位置差异
- 识别差异最大的关节

**监控频率：**
- 命令接收频率：30Hz（每33ms）
- 输出显示频率：每0.5秒（避免刷屏）

**输出格式：**
```
[Piper] ⚠️  警告：关节3差异 22.5度 | 差异: ['2.1', '3.5', '22.5', '1.8', '4.2', '2.0']
```

---

### 4. 三级安全保护

**文件：** `main.py` 第75-80行（配置）、第133-168行（执行）

#### 级别1：启动检查（15度）
```python
POSITION_DIFF_WARNING = 15000  # 15 degrees
```
- **触发时机：** 首次接收命令
- **动作：** 拒绝启动，提示对齐
- **恢复：** 用户手动对齐后自动恢复

#### 级别2：运行警告（15度）
```python
monitor_interval = 0.5  # 每0.5秒检查一次
```
- **触发时机：** 运行中任何关节差异 > 15度
- **动作：** 终端输出警告信息
- **恢复：** 继续运行，持续监控

#### 级别3：紧急停止（20度）
```python
POSITION_DIFF_EMERGENCY = 20000  # 20 degrees
```
- **触发时机：** 任何关节差异 > 20度
- **动作：**
  - 设置 `emergency_stop = True`
  - 拒绝所有后续命令
  - 显示详细错误信息
  - 退出主循环
- **恢复：** 需要重启系统

---

## 参数配置

### 当前配置（main.py 第75-80行）

| 参数 | 值 | 单位 | 说明 |
|------|-----|------|------|
| `POSITION_DIFF_WARNING` | 15000 | 0.001度 | 警告阈值（15度） |
| `POSITION_DIFF_EMERGENCY` | 20000 | 0.001度 | 紧急停止阈值（20度） |
| `monitor_interval` | 0.5 | 秒 | 监控输出间隔 |
| 控制频率 | 30 | Hz | 命令接收频率（不可调） |
| 运动速度 | 60 | % | 从臂运动速度 |

### 参数调整建议

**如果频繁触发警告：**
```python
POSITION_DIFF_WARNING = 25000  # 增加到25度
```

**如果需要更严格的保护：**
```python
POSITION_DIFF_EMERGENCY = 25000  # 降低到25度
monitor_interval = 0.3  # 更频繁的监控输出
```

**如果需要更快的响应：**
```python
piper.MotionCtrl_2(0x01, 0x01, 80, 0x00)  # 提高速度到80%
```
⚠️ **注意：** 提高速度会增加电流消耗，可能增加保险丝熔断风险

---

## 使用说明

### 正常启动流程

1. **启动系统**
   ```bash
   bash /scripts/run_so101.sh
   ```

2. **等待初始化**
   ```
   [Piper] 移动到安全初始位置...
   [Piper] 已到达安全初始位置，准备开始遥操作
   ```

3. **对齐主从臂**（如果需要）
   - 如果看到警告信息，手动移动主臂到接近从臂位置
   - 系统会自动检测并开始遥操作

4. **开始遥操作**
   ```
   [Piper] 开始遥操作控制
   ```

5. **正常操作**
   - 缓慢移动主臂
   - 观察从臂跟随情况
   - 注意终端警告信息

### 更新安全起始位置

如果需要更改从臂的起始位置：

1. **手动移动从臂到期望位置**

2. **读取当前位置**
   ```bash
   python /home/demo/Public/DoRobot/scripts/test_piper_move.py --read-only --can-bus can_left
   ```

3. **更新代码**
   编辑 `main.py` 第60行：
   ```python
   safe_home_position = [新的位置数据]
   ```

4. **重启系统测试**

---

## 故障排查

### 问题1：启动时提示位置差异过大

**现象：**
```
[Piper] 警告：主从臂位置差异过大 (XX度)
[Piper] 请将主臂移动到接近从臂当前位置后再开始遥操作
```

**原因：**
- 主臂和从臂初始位置相差超过20度

**解决方法：**
1. 查看终端显示的从臂当前位置和主臂目标位置
2. 手动移动主臂到接近从臂位置
3. 系统会自动检测并开始遥操作

**预防措施：**
- 每次启动前，将主臂放置在接近从臂起始位置的地方

---

### 问题2：运行中频繁出现警告

**现象：**
```
[Piper] ⚠️  警告：关节3差异 22.5度 | 差异: ['2.1', '3.5', '22.5', '1.8', '4.2', '2.0']
```

**原因：**
- 主臂移动过快
- 从臂跟随速度不够
- 机械臂遇到阻力或障碍物

**解决方法：**
1. **减慢主臂移动速度**
2. **检查从臂是否有障碍物**
3. **检查从臂关节是否灵活**
4. 如果持续出现，考虑提高警告阈值

---

### 问题3：触发紧急停止

**现象：**
```
======================================================================
[Piper] ⚠️  紧急停止！位置差异过大！
======================================================================
关节 X 差异: XX度 (阈值: 30.0度)
```

**原因：**
- 主臂移动过快
- 从臂被卡住或遇到障碍物
- 机械臂硬件故障

**解决方法：**
1. **立即检查从臂状态**
   - 是否有障碍物
   - 关节是否能自由移动
   - 电源和CAN连接是否正常

2. **检查主臂操作**
   - 是否移动过快
   - 是否有突然的大幅度动作

3. **重启系统**
   ```bash
   # 停止当前程序（Ctrl+C）
   # 重新启动
   bash /scripts/run_so101.sh
   ```

4. **如果问题持续**
   - 检查机械臂硬件
   - 检查CAN总线连接
   - 查看系统日志

---

### 问题4：保险丝仍然烧毁

**如果实施所有改进后仍然烧保险丝：**

1. **检查硬件**
   - 保险丝规格是否合适
   - 电源供应是否稳定
   - 机械臂是否有机械故障

2. **降低紧急停止阈值**
   ```python
   POSITION_DIFF_EMERGENCY = 20000  # 降低到20度
   ```

3. **降低运动速度**
   ```python
   piper.MotionCtrl_2(0x01, 0x01, 40, 0x00)  # 降低到40%
   ```

4. **增加监控频率**
   ```python
   monitor_interval = 0.2  # 每0.2秒检查一次
   ```

---

## 维护记录

### 2025-12-25 (更新2)
- **改进内容：** 降低紧急停止阈值，提高安全性
- **修改文件：** `main.py` 第76-77行
- **参数调整：**
  - 警告阈值：20度 → 15度
  - 紧急停止阈值：30度 → 20度
- **测试状态：** 待测试
- **修改人：** 用户请求
- **备注：** 更严格的保护机制，减少保险丝烧毁风险

### 2025-12-25 (初始版本)
- **改进内容：** 初始版本，实现三层安全保护机制
- **修改文件：** `main.py`
- **测试状态：** 待测试
- **修改人：** Claude Code
- **备注：**
  - 安全起始位置：`[5982, -1128, 3940, -19218, 18869, 40103]`
  - 警告阈值：20度
  - 紧急停止阈值：30度

---

### 未来改进计划

- [ ] 添加位置差异历史记录和趋势分析
- [ ] 实现自适应阈值调整
- [ ] 添加数据日志记录功能
- [ ] 实现远程监控和报警
- [ ] 优化紧急停止后的恢复流程

---

## 相关文件

- **主程序：** `main.py`
- **测试脚本：** `/scripts/test_piper_move.py`
- **配置文件：** `dora_teleoperate_dataflow.yml`
- **启动脚本：** `/scripts/run_so101.sh`

---

## 联系方式

如有问题或建议，请联系：
- **项目仓库：** DoRobot
- **文档维护：** 请在此文件中添加维护记录

---

**文档版本：** v1.0
**创建日期：** 2025-12-25
**最后更新：** 2025-12-25
