# ===========================================================================
# DORA Teleoperate Dataflow for SO101 Robot
# ===========================================================================
#
# IMPORTANT: Port Configuration
# -----------------------------
# By default, devices are configured with numeric indices (0, 2, etc.).
# These indices can CHANGE when:
#   - Starting a new episode
#   - Reconnecting USB cables
#   - Rebooting the system
#
# For STABLE port assignments, use persistent paths:
#
#   Cameras: Use /dev/v4l/by-path/... paths
#   Arms:    Use /dev/serial/by-path/... or /dev/serial/by-id/... paths
#
# To find your persistent paths, run:
#   python scripts/detect_usb_ports.py --yaml
#
# Example persistent camera path:
#   CAPTURE_PATH: "/dev/v4l/by-path/platform-xhci-hcd.0-usb-0:1:1.0-video-index0"
#
# Example persistent serial path:
#   PORT: "/dev/serial/by-path/platform-xhci-hcd.0-usb-0:2:1.0"
#
# ===========================================================================

nodes:
  - id: camera_top
    path: ../../components/camera_opencv/main.py
    inputs:
      tick: dora/timer/millis/33
    outputs:
      - image
    env:
      # Use numeric index (may change) or persistent path (stable):
      # CAPTURE_PATH: "/dev/v4l/by-path/platform-xxx-video-index0"
      CAPTURE_PATH: 0
      IMAGE_WIDTH: 640
      IMAGE_HEIGHT: 480

  - id: camera_wrist
    path: ../../components/camera_opencv/main.py
    inputs:
      tick: dora/timer/millis/33
    outputs:
      - image
    env:
      # Use numeric index (may change) or persistent path (stable):
      # CAPTURE_PATH: "/dev/v4l/by-path/platform-xxx-video-index0"
      CAPTURE_PATH: 2
      IMAGE_WIDTH: 640
      IMAGE_HEIGHT: 480

  # - id: camera_wrist2
  #   path: ../../components/camera_opencv/main.py
  #   inputs:
  #     tick: dora/timer/millis/33
  #   outputs:
  #     - image
  #   env:
  #     CAPTURE_PATH: 4
  #     IMAGE_WIDTH: 640
  #     IMAGE_HEIGHT: 480

  - id: arm_so101_leader
    path: ../../components/arm_normal_so101_v1/main.py
    inputs:
      get_joint: dora/timer/millis/33
    outputs:
      - joint
    env:
      GET_DEVICE_FROM: PORT
      # Use direct path (may change) or persistent path (stable):
      # PORT: "/dev/serial/by-path/platform-xxx-port0"
      # PORT: "/dev/serial/by-id/usb-xxx"
      PORT: /dev/ttyACM0
      ARM_NAME: SO101-leader
      ARM_ROLE: leader
      CALIBRATION_DIR: ../../components/arm_normal_so101_v1/.calibration/

  - id: arm_so101_follower
    path: ../../components/arm_normal_so101_v1/main.py
    inputs:
      get_joint: dora/timer/millis/33
      action_joint: arm_so101_leader/joint
      action_joint_ctrl: so101_zeromq/action_joint
    outputs:
      - joint
    env:
      GET_DEVICE_FROM: PORT
      # Use direct path (may change) or persistent path (stable):
      # PORT: "/dev/serial/by-path/platform-xxx-port0"
      # PORT: "/dev/serial/by-id/usb-xxx"
      PORT: /dev/ttyACM1
      ARM_NAME: SO101-follower
      ARM_ROLE: follower
      CALIBRATION_DIR: ../../components/arm_normal_so101_v1/.calibration/

  # - id: arm_so101_leader2
  #   path: ../../components/arm_normal_so101_v1/main.py
  #   inputs:
  #     get_joint: dora/timer/millis/33
  #   outputs:
  #     - joint
  #   env:
  #     GET_DEVICE_FROM: PORT
  #     PORT: /dev/ttyACM2
  #     ARM_NAME: SO101-leader2
  #     ARM_ROLE: leader
  #     CALIBRATION_DIR: ../../components/arm_normal_so101_v1/.calibration/

  # - id: arm_so101_follower2
  #   path: ../../components/arm_normal_so101_v1/main.py
  #   inputs:
  #     get_joint: dora/timer/millis/33
  #     action_joint: arm_so101_leader2/joint
  #     action_joint_ctrl: so101_zeromq/action_joint
  #   outputs:
  #     - joint
  #   env:
  #     GET_DEVICE_FROM: PORT
  #     PORT: /dev/ttyACM3
  #     ARM_NAME: SO101-follower2
  #     ARM_ROLE: follower
  #     CALIBRATION_DIR: ../../components/arm_normal_so101_v1/.calibration/

  - id: so101_zeromq
    path: dora_zeromq.py
    inputs: 
      image_top: camera_top/image
      image_wrist: camera_wrist/image
      # image_wrist2: camera_wrist2/image
      main_leader_joint: arm_so101_leader/joint
      main_follower_joint: arm_so101_follower/joint
      # second_leader_joint: arm_so101_leader2/joint
      # second_follower_joint: arm_so101_follower2/joint
    outputs:
      - action_joint
