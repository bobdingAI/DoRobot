# ===========================================================================
# DORA Teleoperate Dataflow for SO101 Robot
# ===========================================================================
#
# PORT CONFIGURATION
# ------------------
# Ports are configured via environment variables for stability.
# Set these in your shell or run_so101.sh before starting:
#
#   # Cameras (use persistent paths for stability)
#   export CAMERA_TOP_PATH="/dev/v4l/by-path/platform-xhci-hcd.0-usb-0:1:1.0-video-index0"
#   export CAMERA_WRIST_PATH="/dev/v4l/by-path/platform-xhci-hcd.0-usb-0:2:1.0-video-index0"
#
#   # Arms (use persistent paths for stability)
#   export ARM_LEADER_PORT="/dev/serial/by-path/platform-xhci-hcd.0-usb-0:3:1.0"
#   export ARM_FOLLOWER_PORT="/dev/serial/by-path/platform-xhci-hcd.0-usb-0:4:1.0"
#
# To find your persistent paths, run:
#   python scripts/detect_usb_ports.py --yaml
#
# If env vars are not set, defaults will be used (may be unstable):
#   CAMERA_TOP_PATH=0, CAMERA_WRIST_PATH=2
#   ARM_LEADER_PORT=/dev/ttyACM0, ARM_FOLLOWER_PORT=/dev/ttyACM1
#
# ===========================================================================

nodes:
  - id: camera_top
    path: ../../components/camera_opencv/main.py
    inputs:
      tick: dora/timer/millis/33
    outputs:
      - image
    env:
      # Set CAMERA_TOP_PATH env var for persistent path, or uses default
      CAPTURE_PATH: $CAMERA_TOP_PATH
      IMAGE_WIDTH: 640
      IMAGE_HEIGHT: 480

  - id: camera_wrist
    path: ../../components/camera_opencv/main.py
    inputs:
      tick: dora/timer/millis/33
    outputs:
      - image
    env:
      # Set CAMERA_WRIST_PATH env var for persistent path, or uses default
      CAPTURE_PATH: $CAMERA_WRIST_PATH
      IMAGE_WIDTH: 640
      IMAGE_HEIGHT: 480

  # - id: camera_wrist2
  #   path: ../../components/camera_opencv/main.py
  #   inputs:
  #     tick: dora/timer/millis/33
  #   outputs:
  #     - image
  #   env:
  #     CAPTURE_PATH: $CAMERA_WRIST2_PATH
  #     IMAGE_WIDTH: 640
  #     IMAGE_HEIGHT: 480

  - id: arm_so101_leader
    path: ../../components/arm_normal_so101_v1/main.py
    inputs:
      get_joint: dora/timer/millis/33
    outputs:
      - joint
    env:
      GET_DEVICE_FROM: PORT
      # Set ARM_LEADER_PORT env var for persistent path, or uses default
      PORT: $ARM_LEADER_PORT
      ARM_NAME: SO101-leader
      ARM_ROLE: leader
      CALIBRATION_DIR: ../../components/arm_normal_so101_v1/.calibration/

  - id: arm_so101_follower
    path: ../../components/arm_normal_so101_v1/main.py
    inputs:
      get_joint: dora/timer/millis/33
      action_joint: arm_so101_leader/joint
      action_joint_ctrl: so101_zeromq/action_joint
    outputs:
      - joint
    env:
      GET_DEVICE_FROM: PORT
      # Set ARM_FOLLOWER_PORT env var for persistent path, or uses default
      PORT: $ARM_FOLLOWER_PORT
      ARM_NAME: SO101-follower
      ARM_ROLE: follower
      CALIBRATION_DIR: ../../components/arm_normal_so101_v1/.calibration/

  # - id: arm_so101_leader2
  #   path: ../../components/arm_normal_so101_v1/main.py
  #   inputs:
  #     get_joint: dora/timer/millis/33
  #   outputs:
  #     - joint
  #   env:
  #     GET_DEVICE_FROM: PORT
  #     PORT: $ARM_LEADER2_PORT
  #     ARM_NAME: SO101-leader2
  #     ARM_ROLE: leader
  #     CALIBRATION_DIR: ../../components/arm_normal_so101_v1/.calibration/

  # - id: arm_so101_follower2
  #   path: ../../components/arm_normal_so101_v1/main.py
  #   inputs:
  #     get_joint: dora/timer/millis/33
  #     action_joint: arm_so101_leader2/joint
  #     action_joint_ctrl: so101_zeromq/action_joint
  #   outputs:
  #     - joint
  #   env:
  #     GET_DEVICE_FROM: PORT
  #     PORT: $ARM_FOLLOWER2_PORT
  #     ARM_NAME: SO101-follower2
  #     ARM_ROLE: follower
  #     CALIBRATION_DIR: ../../components/arm_normal_so101_v1/.calibration/

  - id: so101_zeromq
    path: dora_zeromq.py
    inputs: 
      image_top: camera_top/image
      image_wrist: camera_wrist/image
      # image_wrist2: camera_wrist2/image
      main_leader_joint: arm_so101_leader/joint
      main_follower_joint: arm_so101_follower/joint
      # second_leader_joint: arm_so101_leader2/joint
      # second_follower_joint: arm_so101_follower2/joint
    outputs:
      - action_joint
