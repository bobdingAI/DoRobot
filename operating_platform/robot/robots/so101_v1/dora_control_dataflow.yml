# ===========================================================================
# DORA Control Dataflow for SO101 Robot (Inference Mode)
# ===========================================================================
#
# This dataflow is used for inference/control mode (no leader arm).
# It uses the SAME environment variables as dora_teleoperate_dataflow.yml
# to ensure port consistency between data collection and inference.
#
# PORT CONFIGURATION
# ------------------
# Set these environment variables before starting:
#
#   # Cameras (use persistent paths for stability)
#   export CAMERA_TOP_PATH="/dev/v4l/by-path/platform-xhci-hcd.0-usb-0:1:1.0-video-index0"
#   export CAMERA_WRIST_PATH="/dev/v4l/by-path/platform-xhci-hcd.0-usb-0:2:1.0-video-index0"
#
#   # Follower arm only (no leader in inference mode)
#   export ARM_FOLLOWER_PORT="/dev/serial/by-path/platform-xhci-hcd.0-usb-0:4:1.0"
#
# To find your persistent paths, run:
#   python scripts/detect_usb_ports.py --yaml
#
# ===========================================================================

nodes:
  - id: camera_top
    path: ../../components/camera_opencv/main.py
    inputs:
      tick: dora/timer/millis/33
    outputs:
      - image
    env:
      # Same env var as teleoperate dataflow for consistency
      CAPTURE_PATH: $CAMERA_TOP_PATH
      IMAGE_WIDTH: 640
      IMAGE_HEIGHT: 480

  - id: camera_wrist
    path: ../../components/camera_opencv/main.py
    inputs:
      tick: dora/timer/millis/33
    outputs:
      - image
    env:
      # Same env var as teleoperate dataflow for consistency
      CAPTURE_PATH: $CAMERA_WRIST_PATH
      IMAGE_WIDTH: 640
      IMAGE_HEIGHT: 480

  - id: arm_so101_follower
    path: ../../components/arm_normal_so101_v1/main.py
    inputs:
      get_joint: dora/timer/millis/33
      action_joint: so101_zeromq/action_joint
    outputs:
      - joint
    env:
      GET_DEVICE_FROM: PORT
      # Same env var as teleoperate dataflow for consistency
      PORT: $ARM_FOLLOWER_PORT
      ARM_NAME: SO101-follower
      ARM_ROLE: follower
      CALIBRATION_DIR: ../../components/arm_normal_so101_v1/.calibration/

  - id: so101_zeromq
    path: dora_zeromq.py
    inputs: 
      image_top: camera_top/image
      image_wrist: camera_wrist/image
      follower_joint: arm_so101_follower/joint
    outputs:
      - action_joint
